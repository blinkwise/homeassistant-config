######################################################
#                 Morning                            #
######################################################
##########################################################################################
- alias: Morning Weather Lights Hot
  trigger:
    platform: time
    after: '6:00:00'
  condition:
    condition: and
    conditions:
      - condition: time
        weekday:
          - mon
          - tue
          - wed
          - thu
          - fri
      - condition: numeric_state
        entity_id: sensor.dark_sky_daily_high_temperature
        above: 80
  action:
    service: light.turn_on
    entity_id:
      - light.hall_3
      - light.hall_4
    data:
      brightness: 150
      color_name: red
##########################################################################################      
- alias: Morning Weather Lights Cold 
  trigger:
    platform: time
    after: '6:00:00'
  condition:
    condition: and
    conditions:
      - condition: time
        weekday:
          - mon
          - tue
          - wed
          - thu
          - fri
      - condition: numeric_state
        entity_id: sensor.dark_sky_daily_high_temperature
        below: 70
  action:
    service: light.turn_on
    entity_id:
      - light.hall_3
      - light.hall_4
    data:
      brightness: 150
      color_name: blue

##########################################################################################
- alias: Morning Weather Lights Lovely
  trigger:
    platform: time
    after: '6:00:00'
  condition:
    condition: and
    conditions:
      - condition: time
        weekday:
          - mon
          - tue
          - wed
          - thu
          - fri
      - condition: numeric_state
        entity_id: sensor.dark_sky_daily_high_temperature
        above: 70
        below: 80
  action:
    service: light.turn_on
    entity_id:
      - light.hall_3
      - light.hall_4
    data:
      brightness: 150
      color_name: green
##########################################################################################     
- alias: Morning Weather Lights Rain
  trigger:
    platform: time
    after: '6:10:00'
  condition:
    condition: and
    conditions:
      - condition: time
        weekday:
          - mon
          - tue
          - wed
          - thu
          - fri
      - condition: numeric_state
        entity_id: sensor.dark_sky_precip_probability
        above: 30
  action:
    service: light.turn_on
    entity_id:
      - light.hall_4
    data:
      brightness: 255
      color_name: purple
##########################################################################################       
######################################################
#                 Kitchen Lights                     #
######################################################

##########################################################################################
- alias: turn on the kitchen lights
  trigger:
    platform: state
    entity_id: input_boolean.roryhome
    from: 'off'
    to: 'on'      
    state: 'on'      
  action:
    service: light.turn_on
    entity_id: light.kitchen
##########################################################################################
- alias: turn on the kitchen lights tracy
  trigger:
    platform: state
    entity_id: input_boolean.tracyhome
    from: 'off'
    to: 'on'      
    state: 'on'
  condition:
    condition: sun
    after: sunset    
  action:
    service: light.turn_on
    entity_id: light.kitchen
##########################################################################################    
- alias: turn on the livingroom lights when home
  trigger:
    platform: state
    entity_id: input_boolean.homestatus
    from: 'off'
    to: 'on'      
    state: 'on'
  condition:
    condition: sun
    after: sunset  
  action:
    service: light.hue_activate_scene
    data:
      group_name: "Living room"
      scene_name: "Beige"     
##########################################################################################    
#- alias: turn on the kitchen lights w/ motion
#  trigger:
#    platform: state
#    entity_id: binary_sensor.kitchen     
#    state: 'on'
#  condition:
#    condition: state
#    entity_id: sun.sun
#    state: 'below_horizon'     
#  action:
#    service: scene.turn_on
#    entity_id: scene.kitchen_dim    
##########################################################################################    
- alias: Turn off kitchen light 2 minutes after last movement
  trigger:
    platform: state
    entity_id: 'binary_sensor.kitchen'
    state: 'off'
    for:
      minutes: 2
  action:
    service: light.turn_off
    entity_id: light.kitchen  
##########################################################################################       
######################################################
#                 Livingroom Lights                  #
######################################################
##########################################################################################
-  alias: Fade on livingroom lights
   trigger:
     platform: numeric_state
     entity_id: sun.sun
     value_template: '{{ state.attributes.elevation }}'
     below: 1.5
   condition:
     condition: and
     conditions:
       - condition: state
         entity_id: 'input_boolean.homestatus'
         state: 'on'
       - condition: state
         entity_id: 'light.mantle_right'
         state: 'off'
   action:
     service: light.hue_activate_scene
     data:
       group_name: "Living room"
       scene_name: "Beige"
       transition: 900
##########################################################################################       
######################################################
#                   Thermostat and Alarm             #
###################################################### 
##########################################################################################
- alias: Check status on reboot rory
  trigger:
    platform: homeassistant
    event: start
  condition:
    condition: and
    conditions:
      - condition: state
        entity_id: device_tracker.rory
        state: 'not home'
      - condition: state
        entity_id: device_tracker.username_rory
        state: 'not home' 
  action:
    - service: homeassistant.turn_off
      entity_id: input_boolean.roryhome
    - service: logbook.log
      data_template:
        name: "Rory away: "
        message: >-
          {%- for state in states if state.entity_id == trigger.entity_id -%}
            {{ state.attributes.friendly_name }} is Away.
          {%- endfor -%}
##########################################################################################
- alias: Check status on reboot tracy away
  trigger:
    platform: homeassistant
    event: start
  condition:
    condition: state
    entity_id: device_tracker.tracy
    state: 'not home'
  action:
    - service: homeassistant.turn_off
      entity_id: input_boolean.tracyhome
    - service: logbook.log
      data_template:
        name: "Tracy away: "
        message: >-
          {%- for state in states if state.entity_id == trigger.entity_id -%}
            {{ state.attributes.friendly_name }} is Away.
          {%- endfor -%} 
##########################################################################################
- alias: Thermostat to Away mode when away
  trigger:
    platform: state
    entity_id: input_boolean.homestatus
    from: 'on'
    to: 'off'
  action:
    service: climate.set_away_mode
    entity_id: climate.lifesupport
##########################################################################################   
- alias: Arm alarm when away
  trigger:
    platform: state
    entity_id: input_boolean.homestatus
    from: 'on'
    to: 'off'
  action:
    - service: alarm_control_panel.alarm_arm_home
      entity_id: alarm_control_panel.sentinel
      data: 
        code: 1127
##########################################################################################      
- alias: Disarm alarm when home
  trigger:
    platform: state
    entity_id: input_boolean.homestatus
    from: 'off'
    to: 'on'          
  action:
    - service: alarm_control_panel.alarm_disarm
      entity_id: alarm_control_panel.sentinel
      data: 
        code: 1127
##########################################################################################        
- alias: set boolean when armed
  trigger:
    platform: state
    entity_id: alarm_control_panel.sentinel
    from: 'disarmed'
    to: 'armed_home'
  action:
    - service: homeassistant.turn_on
      entity_id: input_boolean.alarmstatus
##########################################################################################
- alias: set boolean when disarmed
  trigger:
    platform: state
    entity_id: alarm_control_panel.sentinel
    from: 'armed_home'
    to: 'disarmed'
  action:
    - service: homeassistant.turn_off
      entity_id: input_boolean.alarmstatus
##########################################################################################      
######## IOS notifications for alarm     
##########################################################################################   
- alias: Notify when alarm disarmed
  trigger:
    platform: state
    entity_id: alarm_control_panel.sentinel
    from: 'armed_home'
    to: 'disarmed'
  action:
    service: notify.ios_rory
    data:
      message: 'Alarm disarmed'
##########################################################################################      
- alias: Notify when alarm armed
  trigger:
    platform: state
    entity_id: alarm_control_panel.sentinel
    from: 'disarmed'
    to: 'armed_home'
  action:
    service: notify.ios_rory
    data:
      message: 'Alarm armed'
##########################################################################################
##Turn off panic      
- alias: stop alarm script  when disarmed
  trigger:
    platform: state
    entity_id: alarm_control_panel.sentinel
    state: 'disarmed'
  action:
    service: script.turn_off
    data:
      entity_id: script.light_flash
##########################################################################################
##Basement Motion     
##########################################################################################
- alias: Notify basement motion w/ alarm armed
  trigger:
    platform: state
    entity_id: binary_sensor.basement     
    state: 'on'
  condition:
    condition: state
    entity_id: alarm_control_panel.sentinel
    state: 'armed_home'
  action:
    service: notify.ios_rory
    data:
      message: 'Motion in basement!'
##########################################################################################      
##Kitchen Motion
##########################################################################################
- alias: Notify kitchen motion w/ alarm armed
  trigger:
    platform: state
    entity_id: binary_sensor.kitchen     
    state: 'on'
  condition:
    condition: state
    entity_id: alarm_control_panel.sentinel
    state: 'armed_home'
  action:
    service: notify.ios_rory
    data:
      message: 'Motion in kitchen!'
##########################################################################################      
##Livingroom Motion     
########################################################################################## 
- alias: Notify livingroom motion w/ alarm armed
  trigger:
    platform: state
    entity_id: binary_sensor.livingroom     
    state: 'on'
  condition:
    condition: state
    entity_id: alarm_control_panel.sentinel
    state: 'armed_home'
  action:
    service: notify.ios_rory
    data:
      message: 'Motion in livingroom!'
##########################################################################################      
##Front Motion
##########################################################################################      
- alias: Notify front entrance motion w/ alarm armed
  trigger:
    platform: state
    entity_id: binary_sensor.front_entrance     
    state: 'on'
  condition:
    condition: state
    entity_id: alarm_control_panel.sentinel
    state: 'armed_home'
  action:
    service: notify.ios_rory
    data:
      message: 'Motion in front entrance!'
##########################################################################################      
##Kitchen Door
##########################################################################################      
- alias: Notify kitchen door w/ alarm armed
  trigger:
    platform: state
    entity_id: binary_sensor.garage_door     
    state: 'on'
  condition:
    condition: state
    entity_id: alarm_control_panel.sentinel
    state: 'armed_home'
  action:
    - service: notify.ios_rory
      data:
        message: 'Kitchen entrance opened!'
    - service: script.turn_on
      data:
        entity_id: script.panic
##########################################################################################        
##Deck Door
##########################################################################################      
- alias: Notify deck door w/ alarm armed
  trigger:
    platform: state
    entity_id: binary_sensor.deck_door     
    state: 'on'
  condition:
    condition: state
    entity_id: alarm_control_panel.sentinel
    state: 'armed_home'
  action:
    - service: notify.ios_rory
      data:
        message: 'Deck entrance opened!'
    - service: script.turn_on
      data:
        entity_id: script.panic
##########################################################################################        
##Front Door
##########################################################################################      
- alias: Notify front door w/ alarm armed
  trigger:
    platform: state
    entity_id: binary_sensor.front_door     
    state: 'on'
  condition:
    condition: state
    entity_id: alarm_control_panel.sentinel
    state: 'armed_home'
  action:
    - service: notify.ios_rory
      data:
        message: 'Front entrance opened!'
    - service: script.turn_on
      data:
        entity_id: script.panic
##########################################################################################        
##Basement Door
##########################################################################################      
- alias: Notify basement door w/ alarm armed
  trigger:
    platform: state
    entity_id: binary_sensor.basement_door     
    state: 'on'
  condition:
    condition: state
    entity_id: alarm_control_panel.sentinel
    state: 'armed_home'
  action:
    - service: notify.ios_rory
      data:
        message: 'Basement Door opened!'
    - service: script.turn_on
      data:
        entity_id: script.panic
##########################################################################################        
##Basement Window
##########################################################################################      
- alias: Notify basement door w/ alarm armed
  trigger:
    platform: state
    entity_id: binary_sensor.basement_window     
    state: 'on'
  condition:
    condition: state
    entity_id: alarm_control_panel.sentinel
    state: 'armed_home'
  action:
    - service: notify.ios_rory
      data:
        message: 'Basement window opened!'
    - service: script.turn_on
      data:
        entity_id: script.panic
##########################################################################################        
######################################################
#                 Outside Lights                     #
######################################################
##########################################################################################
- alias: turn on front porch lights
  trigger:
    platform: state
    entity_id: input_boolean.roryhome, input_boolean.tracyhome
    from: 'off'
    to: 'on'      
    state: 'on'
  condition:
    condition: and
    conditions:
      - condition: state
        entity_id: light.front_porch
        state: 'off'
      - condition: state
        entity_id: sun.sun
        state: 'below_horizon'      
  action:
    service: light.turn_on
    entity_id: light.front_porch
##########################################################################################
######################################################
#                Basement Lights                     #
######################################################   
  
##########################################################################################
- alias: turn on the basement lights w/ motion or door
  trigger:
    platform: state
    entity_id: binary_sensor.basement, binary_sensor.basement_door      
    state: 'on'
  condition:
    condition: state
    entity_id: sun.sun
    state: 'below_horizon'     
  action:
    service: scene.turn_on
    entity_id: scene.basement_dim
##########################################################################################    
- alias: Turn off basement light 2 minutes after last movement
  trigger:
    platform: state
    entity_id: binary_sensor.basement, binary_sensor.basement_door 
    state: 'off'
    for:
      minutes: 2
  action:
    service: light.turn_off
    entity_id: light.basement_lights      
##########################################################################################   
    
######################################################
#                 Tracy Notify                       #
######################################################
##########################################################################################
- alias: Flash Mancave when Tracy is home
  trigger:
    platform: state
    entity_id: input_boolean.tracyhome
    from: 'off'
    to: 'on'      
    state: 'on' 
  condition:
    condition: state
    entity_id: input_boolean.roryhome
    state: 'on'     
  action:
    service: light.turn_on
    data:
      entity_id: group.mancave
      flash: long
##########################################################################################  
- alias: Notify when tracy gets home
  trigger:
    platform: state
    entity_id: input_boolean.tracyhome
    from: 'off'
    to: 'on'
  action:
    service: notify.ios_rory
    data:
      message: 'Tracy is now home'
##########################################################################################
- alias: Notify when tracy leaves
  trigger:
    platform: state
    entity_id: input_boolean.tracyhome
    from: 'on'
    to: 'off'
  action:
    service: notify.ios_rory
    data:
      message: 'Tracy left home'
##########################################################################################      
######################################################
#                 Turn Off all lights                #
######################################################
##########################################################################################      
- alias: Turn off Lights when everyone leaves
  trigger:
    platform: state
    entity_id: input_boolean.homestatus
    from: 'on'
    to: 'off'         
  action:
    service: script.lightsoff
##########################################################################################    
  
      
################################################      
#               Rory Home/Away                 #
################################################
##########################################################################################
- alias: 'Rory Home'
  initial_state: 'on'
  trigger:
    - platform: state
      entity_id: device_tracker.rory, device_tracker.username_rory
      state: 'home'
  condition:
    condition: state
    entity_id: input_boolean.roryhome
    state: 'off'
  action:
    - service: homeassistant.turn_on
      entity_id: input_boolean.roryhome
    - service: logbook.log
      data_template:
        name: "Rory home: "
        message: >-
          {%- for state in states if state.entity_id == trigger.entity_id -%}
            {{ state.attributes.friendly_name }} is Home.
          {%- endfor -%}
##########################################################################################
- alias: 'Rory Away'
  initial_state: 'on'  
  trigger:
    - platform: state
      entity_id: device_tracker.rory
      state: 'not_home'
      for: 
        minutes: 10
    - platform: state
      entity_id: device_tracker.username_rory
      state: 'not_home'
  condition:
    condition: and
    conditions:
      - condition: state
        entity_id: device_tracker.rory
        state: 'not home'
      - condition: state
        entity_id: device_tracker.username_rory
        state: 'not home'
  action:
    - service: homeassistant.turn_off
      entity_id: input_boolean.roryhome
    - service: logbook.log
      data_template:
        name: "Rory away: "
        message: >-
          {%- for state in states if state.entity_id == trigger.entity_id -%}
            {{ state.attributes.friendly_name }} is Away.
          {%- endfor -%}               
##########################################################################################     
################################################      
#               Tracy Home/Away                #
################################################
##########################################################################################
- alias: 'Tracy Home' 
  initial_state: 'on'
  trigger:
    - platform: state
      entity_id: device_tracker.tracy, device_tracker.username_tracy
      state: 'home'
  condition:
    condition: state
    entity_id: input_boolean.tracyhome
    state: 'off'
  action:
    - service: homeassistant.turn_on
      entity_id: input_boolean.tracyhome
    - service: logbook.log
      data_template:
        name: "Tracy home: "
        message: >-
          {%- for state in states if state.entity_id == trigger.entity_id -%}
            {{ state.attributes.friendly_name }} is Home.
          {%- endfor -%}
##########################################################################################
- alias: 'Tracy Away'
  initial_state: 'on'
  trigger:
    - platform: state
      entity_id: device_tracker.tracy
      state: 'not_home'
      for: 
        minutes: 10
#    - platform: state
#      entity_id: device_tracker.username_tracy
#      state: 'not_home'
#  condition:
#    condition: and
#    conditions:
#      - condition: state
#        entity_id: device_tracker.tracy
#        state: 'not home'
#      - condition: state
#        entity_id: device_tracker.username_tracy
#        state: 'not home'
  action:
    - service: homeassistant.turn_off
      entity_id: input_boolean.tracyhome
    - service: logbook.log
      data_template:
        name: "Tracy away: "
        message: >-
          {%- for state in states if state.entity_id == trigger.entity_id -%}
            {{ state.attributes.friendly_name }} is Away.
          {%- endfor -%}  
##########################################################################################          
################################################      
#               Home  Home/Away                #
################################################
- alias: 'Home Away'
  initial_state: 'on'       
  trigger:
    - platform: state
      entity_id: input_boolean.tracyhome
      state: 'off'
    - platform: state
      entity_id: input_boolean.roryhome
      state: 'off'  
  condition:
    condition: and
    conditions:
      - condition: state
        entity_id: input_boolean.homestatus
        state: 'on'
      - condition: state
        entity_id: input_boolean.roryhome
        state: 'off' 
      - condition: state
        entity_id: input_boolean.tracyhome
        state: 'off' 
  action:
    - service: homeassistant.turn_off
      entity_id: input_boolean.homestatus
    - service: logbook.log
      data_template:
        name: "Home away: "
        message: >-
          {%- for state in states if state.entity_id == trigger.entity_id -%}
            {{ state.attributes.friendly_name }} is Away.
          {%- endfor -%} 
##########################################################################################          
- alias: 'Home Active'
  initial_state: 'on'
  trigger:
    - platform: state
      entity_id: input_boolean.tracyhome
      state: 'on'
    - platform: state
      entity_id: input_boolean.roryhome
      state: 'on' 
  condition:
    condition: state
    entity_id: input_boolean.homestatus
    state: 'off'     
  action:
    - service: homeassistant.turn_on
      entity_id: input_boolean.homestatus
    - service: logbook.log
      data_template:
        name: "Home Active: "
        message: >-
          {%- for state in states if state.entity_id == trigger.entity_id -%}
            {{ state.attributes.friendly_name }} is Away.
          {%- endfor -%}         
##########################################################################################
################################################      
#               Traffic Notify                 #
################################################
##########################################################################################
- alias: 'Commute Home'
  initial_state: 'on'
  trigger:
    - platform: time
      after: '16:30:00'
  condition:
    condition: and
    conditions:
     - condition: time
       after: '14:00:00'
       before: '20:00:00'
     - condition: time
       weekday:
         - mon
         - tue
         - wed
         - thu
         - fri
     - condition: state
       entity_id: input_boolean.roryhome
       state: 'off'   
  action:
    service: notify.ios_rory
    data_template:
      title: "Time to go!"
      message: >
        It will take {{ states("sensor.evening_commute_rory") }} minutes to get home.
########################################################################################## 